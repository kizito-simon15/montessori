<form id="filter-form" method="get">
    <div class="table-container" style="width: 100%; position: relative; display: block;">
        <table class="styled-table" id="resultsTable" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead style="background-color: #007bff; color: white;">
                <tr>
                    <th class="sticky-col">S/N</th>
                    <th class="sticky-col">STUDENT</th>
                    <th class="sticky-col">SEX</th>
                    <th class="sticky-col">CLASS</th>
                    {% for subject in subjects %}
                    <th colspan="3">{{ subject }}</th>
                    {% endfor %}
                    <th>TOTAL</th>
                    <th>AVERAGE</th>
                    <th>STATUS</th>
                    <th>POSITION</th>
                </tr>
                <tr>
                    <th class="sticky-col"></th>
                    <th class="sticky-col"></th>
                    <th class="sticky-col"></th>
                    <th class="sticky-col"></th>
                    {% for subject in subjects %}
                    <th>Test</th>
                    <th>Exam</th>
                    <th>Avg</th>
                    {% endfor %}
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="resultsTableBody">
                {% for student_data in data %}
                    {% include 'result/partials/_results_row.html' with student_data=student_data counter=forloop.counter %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <p id="noResultsMessage" style="color: red; font-size: 16px; text-align: center; margin-top: 15px; display: none;">
        ‚ùå No results found for the selected filters.
    </p>
</form>

<script>
    let nameSortAsc = true;
    let avgSortAsc = true;

    function toggleSortByName() {
        let tbody = document.querySelector("#resultsTableBody");
        let rows = Array.from(tbody.getElementsByTagName("tr"));

        rows.sort((a, b) => {
            let nameA = a.getAttribute("data-name").toLowerCase();
            let nameB = b.getAttribute("data-name").toLowerCase();
            return nameSortAsc ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
        });

        nameSortAsc = !nameSortAsc;
        rows.forEach(row => tbody.appendChild(row));
    }

    function toggleSortByAverage() {
        let tbody = document.querySelector("#resultsTableBody");
        let rows = Array.from(tbody.getElementsByTagName("tr"));

        rows.sort((a, b) => {
            let avgA = parseFloat(a.getAttribute("data-average"));
            let avgB = parseFloat(a.getAttribute("data-average"));
            return avgSortAsc ? avgA - avgB : avgB - avgA;
        });

        avgSortAsc = !avgSortAsc;
        rows.forEach(row => tbody.appendChild(row));
    }

    function checkNoResults() {
        let tbody = document.getElementById("resultsTableBody");
        let thead = document.querySelector(".styled-table thead");
        let noResultsMessage = document.getElementById("noResultsMessage");
        let rows = tbody.querySelectorAll("tr");
        let visibleRows = Array.from(rows).filter(row => row.style.display !== "none");

        if (visibleRows.length === 0) {
            thead.style.display = "none";
            noResultsMessage.style.display = "block";
        } else {
            thead.style.display = "table-header-group";
            noResultsMessage.style.display = "none";
        }
    }

    document.addEventListener("DOMContentLoaded", checkNoResults);

    // Enhance mobile scrolling for table-container
    const tables = document.querySelectorAll('.table-container');
    tables.forEach(table => {
        let isDragging = false;
        let startX;
        let scrollLeft;

        table.addEventListener('touchstart', (e) => {
            isDragging = true;
            startX = e.touches[0].pageX - table.offsetLeft;
            scrollLeft = table.scrollLeft;
        });

        table.addEventListener('touchend', () => {
            isDragging = false;
        });

        table.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.touches[0].pageX - table.offsetLeft;
            const walk = (x - startX) * 2;
            table.scrollLeft = scrollLeft - walk;
        });

        table.addEventListener('scroll', () => {
            const maxScroll = table.scrollWidth - table.clientWidth;
            table.classList.toggle('scroll-start', table.scrollLeft > 0);
            table.classList.toggle('scroll-end', table.scrollLeft < maxScroll);
        });
    });
</script>

<style>
    .table-container {
        width: 100%;
        height: 600px; /* Fixed height for vertical scrolling on desktop */
        overflow-x: auto;
        overflow-y: auto; /* Enable vertical scrolling */
        -webkit-overflow-scrolling: touch;
        position: relative;
        display: block; /* Ensure proper height calculation */
    }

    .styled-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 16px;
        text-align: center;
        min-height: 620px; /* Ensure table content exceeds container height for scrolling */
    }

    .styled-table thead {
        background-color: #007bff;
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .styled-table thead tr {
        background-color: #007bff;
        color: white;
        font-weight: bold;
    }

    .styled-table th, .styled-table td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        border-right: 1px solid #ddd;
        vertical-align: middle;
    }

    /* Allow wrapping for the STUDENT column */
    .styled-table th:nth-child(2),
    .styled-table td:nth-child(2) {
        white-space: normal;
        min-width: 150px;
        max-width: 200px;
    }

    /* Ensure other columns don't wrap */
    .styled-table th:not(:nth-child(2)),
    .styled-table td:not(:nth-child(2)) {
        white-space: nowrap;
        min-width: 60px;
    }

    /* Remove right border for last column */
    .styled-table th:last-child, .styled-table td:last-child {
        border-right: none;
    }

    .styled-table tbody tr:hover {
        background-color: #f1f5f9;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background: #fff;
        z-index: 5;
    }

    .styled-table thead .sticky-col {
        background: #007bff;
        z-index: 15;
    }

    .sticky-col:nth-child(2) {
        left: 40px;
    }

    .sticky-col:nth-child(3) {
        left: 190px;
    }

    .sticky-col:nth-child(4) {
        left: 240px;
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
        .table-container {
            height: 400px; /* Fixed height for vertical scrolling on mobile */
            overflow-x: auto;
            overflow-y: auto; /* Ensure vertical scrolling on mobile */
            -webkit-overflow-scrolling: touch;
            position: relative;
            display: block; /* Ensure proper height calculation */
        }

        .styled-table {
            font-size: 14px;
            min-width: 1200px; /* Ensures full horizontal scroll on mobile */
            min-height: 420px; /* Ensure table content exceeds container height for scrolling */
        }

        .styled-table th, .styled-table td {
            padding: 6px;
        }

        .styled-table th:nth-child(2),
        .styled-table td:nth-child(2) {
            min-width: 120px;
            max-width: 150px;
        }

        .styled-table th:not(:nth-child(2)),
        .styled-table td:not(:nth-child(2)) {
            min-width: 50px;
        }

        .sticky-col:nth-child(2) {
            left: 30px;
        }

        .sticky-col:nth-child(3) {
            left: 150px;
        }

        .sticky-col:nth-child(4) {
            left: 200px;
        }
    }
</style>