{% extends "headteacher/base.html" %}
{% load static %}

{% block title %}
Student Details: {{ object }}
{% endblock title %}

{% block content %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Print page function
    function printPage() {
        document.body.classList.add('printing');
        window.print();
        document.body.classList.remove('printing');
    }

    // Go back function
    function goBack() {
        window.history.back();
    }

    // Expose functions to global scope
    window.printPage = printPage;
    window.goBack = goBack;

    // Calculate payment totals
    function calculateTotal() {
        let totalPayable = 0;
        let totalPaid = 0;
        let totalBalance = 0;

        document.querySelectorAll('#payment-table tbody tr').forEach(row => {
            const payable = parseFloat(row.cells[1].innerText) || 0;
            const paid = parseFloat(row.cells[2].innerText) || 0;
            const balance = parseFloat(row.cells[3].innerText) || 0;

            totalPayable += payable;
            totalPaid += paid;
            totalBalance += balance;
        });

        document.getElementById('total-payable').innerText = totalPayable.toFixed(2);
        document.getElementById('total-paid').innerText = totalPaid.toFixed(2);
        document.getElementById('total-balance').innerText = totalBalance.toFixed(2);
    }

    // Toggle details visibility
    const detailsElements = document.querySelectorAll('.details-section details');
    detailsElements.forEach((details, index) => {
        const summary = details.querySelector('summary');
        const isCollapsed = localStorage.getItem(`student-detail-details-${index}`) === 'collapsed';
        
        if (isCollapsed) {
            details.removeAttribute('open');
        } else {
            details.setAttribute('open', '');
        }

        summary.addEventListener('click', () => {
            const isNowCollapsed = !details.hasAttribute('open');
            localStorage.setItem(`student-detail-details-${index}`, isNowCollapsed ? 'collapsed' : 'expanded');
        });
    });

    // Sticky header on scroll
    const header = document.querySelector('.title-section');
    let lastScrollY = window.scrollY;

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    const handleScroll = debounce(() => {
        const currentScrollY = window.scrollY;
        if (currentScrollY > lastScrollY && currentScrollY > 50) {
            header.classList.add('sticky');
        } else {
            header.classList.remove('sticky');
        }
        lastScrollY = currentScrollY;
    }, 100);

    window.addEventListener('scroll', handleScroll);

    // Fade-in animation for card
    const card = document.querySelector('.main-card');
    card.style.opacity = '0';
    setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
    }, 100);

    // Make payment rows clickable
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', () => {
            const href = row.getAttribute('data-href');
            if (href) window.location.href = href;
        });
    });

    // Calculate totals on load
    calculateTotal();
});
</script>

<style>
:root {
    --primary: #1e3a8a;
    --secondary: #d97706;
    --sidebar-bg: #2e1065;
    --sidebar-hover: #a78bfa;
    --sidebar-active: #6d28d9;
    --success: #16a34a;
    --danger: #dc2626;
    --info: #0284c7;
}

body {
    background: #f1f5f9;
    font-family: 'Inter', sans-serif;
    margin: 0;
    overflow-x: hidden;
}

.main-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: opacity 0.5s ease, transform 0.5s ease;
    transform: translateY(20px);
    animation: slideInDown 0.5s ease forwards;
}

.title-section {
    background: linear-gradient(145deg, var(--primary), var(--secondary));
    color: #fff;
    border-radius: 12px 12px 0 0;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 10;
}

.title-section.sticky {
    position: sticky;
    top: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.title-section h2 {
    font-size: clamp(1.5rem, 5vw, 1.8rem);
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.title-section .btn-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.card-body {
    display: grid;
    grid-template-columns: 1fr 3fr;
    gap: 1rem;
    padding: 1rem;
}

.profile-section {
    text-align: center;
    padding: 0.5rem;
}

.profile-pic {
    width: clamp(100px, 20vw, 150px);
    height: clamp(100px, 20vw, 150px);
    border-radius: 50%;
    border: 4px solid var(--primary);
    object-fit: cover;
    transition: transform 0.3s ease;
}

.profile-pic:hover {
    transform: scale(1.05);
}

.student-name {
    font-size: clamp(1.2rem, 4vw, 1.4rem);
    font-weight: 700;
    color: #333;
    margin: 0.5rem 0 0.25rem;
}

.student-class {
    font-size: clamp(0.9rem, 3.5vw, 1rem);
    font-weight: 600;
    color: var(--secondary);
    margin: 0;
}

.student-status {
    font-size: clamp(0.8rem, 3vw, 0.9rem);
    font-weight: 600;
    color: var(--success);
    margin: 0.25rem 0;
}

.student-status.inactive {
    color: var(--danger);
}

.details-section {
    padding: 0.5rem;
}

details {
    border: none;
    border-radius: 8px;
    background: #f9fafb;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: box-shadow 0.2s ease;
}

details:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

summary {
    font-size: clamp(0.85rem, 3vw, 0.95rem);
    font-weight: 600;
    color: var(--sidebar-bg);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    cursor: pointer;
    transition: color 0.2s ease;
}

summary:hover {
    color: var(--sidebar-hover);
}

summary::marker {
    content: none;
}

details[open] summary::after {
    content: '▼';
    margin-left: 0.5rem;
}

details:not([open]) summary::after {
    content: '▶';
    margin-left: 0.5rem;
}

details hr {
    border: 0;
    border-top: 1px solid var(--sidebar-bg);
    margin: 0 0.5rem 0.5rem;
}

.detail-content {
    padding: 0 0.5rem 0.5rem;
}

.detail-line {
    display: flex;
    align-items: center;
    margin-bottom: 0.25rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid #e5e7eb;
}

.detail-line:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.detail-icon {
    font-size: clamp(0.9rem, 3vw, 1rem);
    color: var(--secondary);
    margin-right: 0.5rem;
    flex-shrink: 0;
}

.detail-label {
    font-weight: 600;
    color: #333;
    margin-right: 0.5rem;
    white-space: nowrap;
    flex-shrink: 0;
    font-size: clamp(0.8rem, 3vw, 0.9rem);
}

.detail-value {
    color: #555;
    flex: 1;
    font-size: clamp(0.8rem, 3vw, 0.9rem);
}

.nhif-yes, .term-assigned {
    color: var(--success);
    font-weight: 600;
}

.nhif-no, .term-not-assigned {
    color: var(--danger);
    font-weight: 600;
}

.btn {
    border-radius: 25px;
    font-weight: 600;
    font-size: clamp(0.8rem, 3vw, 0.9rem);
    padding: 0.5rem 1rem;
    transition: background 0.2s ease, transform 0.2s ease;
}

.btn-sm {
    font-size: clamp(0.7rem, 2.5vw, 0.8rem);
    padding: 0.4rem 0.8rem;
}

.btn-info {
    background: var(--info);
    color: #fff;
    border: none;
}

.btn-success {
    background: var(--success);
    color: #fff;
    border: none;
}

.btn-danger {
    background: var(--danger);
    color: #fff;
    border: none;
}

.btn-secondary {
    background: #6b7280;
    color: #fff;
    border: none;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn-info:hover {
    background: #0369a1;
}

.btn-success:hover {
    background: var(--secondary);
}

.btn-danger:hover {
    background: #b91c1c;
}

.btn-secondary:hover {
    background: #4b5563;
}

.table-responsive {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: #fff;
    min-width: 600px;
}

thead {
    background: var(--sidebar-bg);
    color: #fff;
    position: sticky;
    top: 0;
    z-index: 10;
}

thead th {
    padding: 0.5rem 0.75rem;
    font-size: clamp(0.75rem, 2.5vw, 0.85rem);
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
    border: none;
}

tbody tr {
    transition: background 0.2s ease;
    cursor: pointer;
}

tbody tr:nth-child(even) {
    background: #f9fafb;
}

tbody tr:hover {
    background: #e0f2fe;
}

td {
    padding: 0.5rem 0.75rem;
    font-size: clamp(0.8rem, 3vw, 0.9rem);
    color: #333;
    white-space: nowrap;
    border: none;
}

.printing .title-section .btn-group,
.printing .title-section.sticky {
    display: none;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .card-body {
        grid-template-columns: 1fr;
    }
    .profile-section {
        margin-bottom: 0.5rem;
    }
    .title-section {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
    }
    .title-section .btn-group {
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .profile-pic {
        width: clamp(80px, 20vw, 120px);
        height: clamp(80px, 20vw, 120px);
    }
    .title-section h2 {
        font-size: clamp(1.2rem, 4vw, 1.4rem);
    }
}
</style>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mt-2">{{ message }}</div>
    {% endfor %}
{% endif %}

<div class="main-card">
    <div class="title-section">
        <h2><i class="fas fa-user-graduate"></i> Student Details</h2>
        <div class="btn-group">
            <button class="btn btn-secondary btn-sm" onclick="printPage()" title="Print this page">
                <i class="fas fa-print"></i> Print
            </button>
            <a href="{% url 'headteacher_student_update' object.id %}" class="btn btn-success btn-sm">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{% url 'headteacher_student_delete' object.id %}" class="btn btn-danger btn-sm">
                <i class="fas fa-trash-alt"></i> Delete
            </a>
            <button class="btn btn-secondary btn-sm" onclick="goBack()" title="Go Back">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <a href="{% url 'headteacher_student_list' %}" class="btn btn-info btn-sm">
                <i class="fas fa-list"></i> Student List
            </a>
            <a href="{% url 'headteacher_historical_term_assignments' object.id %}" class="btn btn-info btn-sm">
                <i class="fas fa-history"></i> Historical Terms
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Profile Section -->
        <div class="profile-section">
            {% if object.passport %}
                <img src="{{ object.passport.url }}" alt="Student Photo" class="profile-pic">
            {% else %}
                <img src="{% static 'dist/img/avatar.png' %}" alt="Default Avatar" class="profile-pic">
            {% endif %}
            <h4 class="student-name">
                {{ object.firstname }} {{ object.middle_name|default_if_none:'' }} {{ object.surname|default_if_none:'' }}
            </h4>
            <p class="student-class">
                {{ object.current_class.name|default:"N/A" }}
            </p>
            <p class="student-status {% if object.current_status == 'inactive' %}inactive{% endif %}">
                {{ object.current_status|capfirst }}
            </p>
        </div>

        <!-- Details Section -->
        <div class="details-section">
            <!-- Personal Information -->
            <details open>
                <summary><i class="fas fa-info-circle"></i> Personal Information</summary>
                <hr>
                <div class="detail-content">
                    <div class="detail-line">
                        <i class="fas fa-toggle-on detail-icon"></i>
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">{{ object.current_status|capfirst }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-id-card detail-icon"></i>
                        <span class="detail-label">Registration No:</span>
                        <span class="detail-value">{{ object.registration_number|default:"N/A" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-user detail-icon"></i>
                        <span class="detail-label">Full Name:</span>
                        <span class="detail-value">{{ object.firstname }} {{ object.middle_name|default_if_none:'' }} {{ object.surname|default_if_none:'' }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-venus-mars detail-icon"></i>
                        <span class="detail-label">Gender:</span>
                        <span class="detail-value">{{ object.get_gender_display|capfirst }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-birthday-cake detail-icon"></i>
                        <span class="detail-label">Date of Birth:</span>
                        <span class="detail-value">{{ object.date_of_birth|default:"N/A" }}</span>
                    </div>
                </div>
            </details>

            <!-- Contact Information -->
            <details open>
                <summary><i class="fas fa-map-marker-alt"></i> Contact Information</summary>
                <hr>
                <div class="detail-content">
                    <div class="detail-line">
                        <i class="fas fa-phone detail-icon"></i>
                        <span class="detail-label">Guardian 1 Mobile:</span>
                        <span class="detail-value">{{ object.guardian1_mobile_number|default:"N/A" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-phone detail-icon"></i>
                        <span class="detail-label">Guardian 2 Mobile:</span>
                        <span class="detail-value">{{ object.guardian2_mobile_number|default:"N/A" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-map-marker-alt detail-icon"></i>
                        <span class="detail-label">Address:</span>
                        <span class="detail-value">{{ object.address|default:"N/A" }}</span>
                    </div>
                </div>
            </details>

            <!-- Academic Details -->
            <details open>
                <summary><i class="fas fa-school"></i> Academic Details</summary>
                <hr>
                <div class="detail-content">
                    <div class="detail-line">
                        <i class="fas fa-calendar-alt detail-icon"></i>
                        <span class="detail-label">Admission Date:</span>
                        <span class="detail-value">{{ object.date_of_admission|default:"N/A" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-school detail-icon"></i>
                        <span class="detail-label">Class:</span>
                        <span class="detail-value">{{ object.current_class.name|default:"N/A" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-home detail-icon"></i>
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">{{ object.get_category_display|default:"N/A" }}</span>
                    </div>
                </div>
            </details>

            <!-- Term Assignments -->
            <details open>
                <summary><i class="fas fa-calendar-alt"></i> Current Session Term Assignments</summary>
                <hr>
                <div class="detail-content">
                    {% if term_assignments %}
                        {% for assignment in term_assignments %}
                            <div class="detail-line">
                                <i class="fas fa-calendar-alt detail-icon"></i>
                                <span class="detail-label">Term:</span>
                                <span class="detail-value {% if assignment.academic_term.current %}term-assigned{% else %}term-not-assigned{% endif %}">
                                    {{ assignment.academic_term }} - Assigned on {{ assignment.assigned_date }}
                                </span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="detail-line">
                            <i class="fas fa-calendar-alt detail-icon"></i>
                            <span class="detail-label">Term:</span>
                            <span class="detail-value term-not-assigned">No term assignments for current session</span>
                        </div>
                    {% endif %}
                </div>
            </details>

            <!-- Health Information -->
            <details open>
                <summary><i class="fas fa-heartbeat"></i> Health Information</summary>
                <hr>
                <div class="detail-content">
                    <div class="detail-line">
                        <i class="fas fa-hospital detail-icon"></i>
                        <span class="detail-label">Has NHIF:</span>
                        <span class="detail-value">
                            {% if object.has_nhif %}
                                <span class="nhif-yes">✔</span>
                            {% else %}
                                <span class="nhif-no">✩</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-hospital-user detail-icon"></i>
                        <span class="detail-label">NHIF Source:</span>
                        <span class="detail-value">{{ object.get_nhif_source_display|default:"N/A" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-id-card detail-icon"></i>
                        <span class="detail-label">NHIF Number:</span>
                        <span class="detail-value">{{ object.nhif_number|default:"N/A" }}</span>
                    </div>
                </div>
            </details>

            <!-- Additional Information -->
            <details open>
                <summary><i class="fas fa-info-circle"></i> Additional Details</summary>
                <hr>
                <div class="detail-content">
                    <div class="detail-line">
                        <i class="fas fa-id-card detail-icon"></i>
                        <span class="detail-label">Parent Student ID:</span>
                        <span class="detail-value">{{ object.parent_student_id|default:"N/A" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-comment detail-icon"></i>
                        <span class="detail-label">Comments:</span>
                        <span class="detail-value">{{ object.others|default:"No additional info" }}</span>
                    </div>
                    <div class="detail-line">
                        <i class="fas fa-graduation-cap detail-icon"></i>
                        <span class="detail-label">Completed:</span>
                        <span class="detail-value">
                            {% if object.completed %}
                                Yes
                            {% else %}
                                No
                            {% endif %}
                        </span>
                    </div>
                </div>
            </details>

            <!-- Invoice/Payment History -->
            <details open>
                <summary><i class="fas fa-file-invoice-dollar"></i> Payment History</summary>
                <hr>
                <div class="detail-content">
                    {% if payments %}
                        <div class="table-responsive">
                            <table id="payment-table">
                                <thead>
                                    <tr>
                                        <th>For</th>
                                        <th>Amount Payable</th>
                                        <th>Amount Paid</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in payments %}
                                        <tr class="clickable-row" data-href="{% url 'invoice-detail' payment.id %}">
                                            <td>{{ payment.session }} - {{ payment.installment }} - {{ payment.class_for }}</td>
                                            <td>{{ payment.total_amount_payable }}</td>
                                            <td>{{ payment.total_amount_paid }}</td>
                                            <td>{{ payment.balance }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th>Total:</th>
                                        <td id="total-payable" class="fw-bold text-primary"></td>
                                        <td id="total-paid" class="fw-bold text-primary"></td>
                                        <td id="total-balance" class="fw-bold text-primary"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No payment history available.</p>
                    {% endif %}
                </div>
            </details>
        </div>
    </div>
</div>
{% endblock content %}